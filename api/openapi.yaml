openapi: "3.1.0"
info:
  title: Go API Starter
  description: |
    Production-ready REST API with JWT authentication, built with Go.

    ## Features
    - üîê JWT-based authentication
    - üìù CRUD operations for TODOs
    - üè• Health check endpoints
    - üìä Prometheus metrics
    - ‚ö° Rate limiting
    - üîÑ Circuit breaker pattern

    ## Authentication
    All endpoints except `/auth/*` and `/health/*` require JWT authentication.
    Include the token in the `Authorization` header: `Bearer <token>`
  version: "1.0.0"
  contact:
    name: API Support
    url: https://github.com/hassan123789/go-api-starter
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: auth
    description: Authentication operations
  - name: todos
    description: TODO management operations
  - name: health
    description: Health check endpoints

paths:
  /auth/register:
    post:
      tags:
        - auth
      summary: Register a new user
      description: Create a new user account
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
            examples:
              newUser:
                summary: New user registration
                value:
                  email: user@example.com
                  password: securePassword123
                  name: John Doe
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login:
    post:
      tags:
        - auth
      summary: Login user
      description: Authenticate user and return JWT token
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            examples:
              validLogin:
                summary: Valid login credentials
                value:
                  email: user@example.com
                  password: securePassword123
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /todos:
    get:
      tags:
        - todos
      summary: List all TODOs
      description: Get all TODOs for the authenticated user
      operationId: listTodos
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          description: Maximum number of TODOs to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of TODOs to skip
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: completed
          in: query
          description: Filter by completion status
          schema:
            type: boolean
      responses:
        "200":
          description: List of TODOs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoListResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      tags:
        - todos
      summary: Create a new TODO
      description: Create a new TODO for the authenticated user
      operationId: createTodo
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTodoRequest"
            examples:
              simpleTodo:
                summary: Simple TODO
                value:
                  title: Buy groceries
                  description: Milk, eggs, bread
      responses:
        "201":
          description: TODO created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /todos/{id}:
    get:
      tags:
        - todos
      summary: Get TODO by ID
      description: Get a specific TODO by its ID
      operationId: getTodoById
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/TodoId"
      responses:
        "200":
          description: TODO found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    put:
      tags:
        - todos
      summary: Update TODO
      description: Update an existing TODO
      operationId: updateTodo
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/TodoId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateTodoRequest"
      responses:
        "200":
          description: TODO updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      tags:
        - todos
      summary: Delete TODO
      description: Delete a TODO by ID
      operationId: deleteTodo
      security:
        - bearerAuth: []
      parameters:
        - $ref: "#/components/parameters/TodoId"
      responses:
        "204":
          description: TODO deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Check if the service is healthy
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "503":
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /health/live:
    get:
      tags:
        - health
      summary: Liveness probe
      description: Kubernetes liveness probe endpoint
      operationId: livenessProbe
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProbeResponse"
        "503":
          description: Service is not alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProbeResponse"

  /health/ready:
    get:
      tags:
        - health
      summary: Readiness probe
      description: Kubernetes readiness probe endpoint
      operationId: readinessProbe
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProbeResponse"
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProbeResponse"

  /metrics:
    get:
      tags:
        - health
      summary: Prometheus metrics
      description: Prometheus metrics endpoint
      operationId: getMetrics
      responses:
        "200":
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

  parameters:
    TodoId:
      name: id
      in: path
      required: true
      description: TODO ID
      schema:
        type: string
        format: uuid

  schemas:
    RegisterRequest:
      type: object
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          minLength: 8
          description: User's password (minimum 8 characters)
          example: securePassword123
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: User's display name
          example: John Doe

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          format: password
          description: User's password
          example: securePassword123

    CreateTodoRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: TODO title
          example: Buy groceries
        description:
          type: string
          maxLength: 1000
          description: TODO description
          example: Milk, eggs, bread

    UpdateTodoRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: TODO title
        description:
          type: string
          maxLength: 1000
          description: TODO description
        completed:
          type: boolean
          description: Whether the TODO is completed

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: User ID
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: User's display name
        created_at:
          type: string
          format: date-time
          description: Account creation timestamp

    TokenResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
        token_type:
          type: string
          enum: [Bearer]
          description: Token type
        expires_in:
          type: integer
          description: Token expiration time in seconds

    TodoResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: TODO ID
        title:
          type: string
          description: TODO title
        description:
          type: string
          description: TODO description
        completed:
          type: boolean
          description: Whether the TODO is completed
        user_id:
          type: string
          format: uuid
          description: Owner's user ID
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp

    TodoListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/TodoResponse"
        total:
          type: integer
          description: Total number of TODOs
        limit:
          type: integer
          description: Maximum items per page
        offset:
          type: integer
          description: Number of items skipped

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Overall health status
        checks:
          type: object
          additionalProperties:
            type: object
            properties:
              status:
                type: string
                enum: [healthy, unhealthy]
              latency:
                type: string
                description: Check latency
              error:
                type: string
                description: Error message if unhealthy
        timestamp:
          type: string
          format: date-time

    ProbeResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error details

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: VALIDATION_ERROR
              message: Invalid request body
              details:
                field: email
                reason: must be a valid email address

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: UNAUTHORIZED
              message: Authentication required

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: NOT_FOUND
              message: Resource not found

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: INTERNAL_ERROR
              message: An unexpected error occurred
